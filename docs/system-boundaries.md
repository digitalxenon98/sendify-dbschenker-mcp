# System Boundaries & Technical Considerations

## CAPTCHA Protection Mechanism

The DB Schenker tracking endpoint (`/nges-portal/api/public/tracking-public`) is protected by browser-level CAPTCHA mechanisms. This is not a public API in the traditional sense, but rather a browser-protected service that requires client-side CAPTCHA solving.

When requests are made from a browser, a dynamically generated `Captcha-Solution` header is included. This token is produced client-side as part of an anti-bot challenge and cannot be generated by a server-side client.

If the required `Captcha-Solution` header is missing, the upstream service responds deterministically with HTTP 429 and a `Captcha-Puzzle` response header. This response indicates an enforced system boundary rather than transient rate limiting.

### How CAPTCHA Protection Works

- The upstream service requires a `Captcha-Solution` header that can only be generated by a browser executing JavaScript-based CAPTCHA challenges.
- Server-side requests without this header receive HTTP 429 responses with a `Captcha-Puzzle` response header.
- This is a deterministic, intentional system boundary, not a transient failure or rate limit.

## System Behavior

### CAPTCHA Detection & Handling

- **CAPTCHA Detection**: The client detects CAPTCHA blocking by checking for HTTP 429 responses combined with the presence of `Captcha-Puzzle` headers.
- **Non-Retryable Failures**: CAPTCHA-related HTTP 429 responses are treated as non-retryable. No exponential backoff or retry logic is applied, as retrying would not resolve the missing CAPTCHA solution.
- **Fail Fast**: The client fails fast instead of retrying or backing off when CAPTCHA is detected.
- **Structured Error Response**: The limitation is surfaced clearly through structured error responses with `status: "blocked"` and `retryable: false`, clearly distinguishing this from transient failures.
- **Failure Caching**: CAPTCHA-blocked results are cached for 60 seconds to avoid repeated upstream requests for the same reference number.

## Ethical Boundaries

This implementation explicitly respects CAPTCHA protections as a system boundary:

- **No CAPTCHA Bypass**: No attempt is made to bypass, automate, or solve CAPTCHA challenges.
- **No Browser Automation**: No browser automation tools (Playwright, Puppeteer, Selenium) are used.
- **No Token Replay**: No hard-coded tokens or header replay mechanisms are employed.
- **Fail Fast**: The system fails gracefully and immediately when CAPTCHA blocking is detected, rather than attempting workarounds.

This approach reflects correct and ethical engineering practice and avoids interacting with the upstream service in unsupported or brittle ways.

## Retry Semantics & Rate Limiting

The implementation includes retry mechanisms for transient server errors, but distinguishes between retryable failures and hard system boundaries:

- **Exponential Backoff for Transient Errors**: Transient server errors (HTTP 5xx) are retried using exponential backoff, providing up to 3 retry attempts with increasing delays. This applies only to genuine transient failures.

- **CAPTCHA Blocking vs. Rate Limiting**: HTTP 429 responses are handled differently based on their cause:
  - **CAPTCHA-related HTTP 429**: Detected and treated as a hard, non-retryable boundary. The client fails fast and returns a structured "blocked" response.
  - **True rate limiting**: If a 429 occurs without CAPTCHA headers (unlikely but possible), it may be retried with exponential backoff as a transient rate limit.

- **Response Caching**: Successful responses are cached in memory for a short period (currently 60 seconds) to reduce upstream load and avoid unnecessary repeated calls.

- **Graceful Error Handling**: The tool returns clear, structured error messages that distinguish between different failure modes, allowing downstream consumers to make informed decisions about retry behavior.

By differentiating these cases, the system remains resilient while respecting upstream constraints and usage boundaries.

## Production Considerations

A real production solution would require one of the following approaches:

- An official DB Schenker API with proper authentication
- A partner integration program with DB Schenker
- Explicit user-initiated browser flows where users solve CAPTCHA challenges themselves

