# Debugging CAPTCHA Solving Process

This guide explains how to inspect and understand how DB Schenker's browser JavaScript solves the CAPTCHA puzzle.

## Quick Start

Run the debug script:

```bash
npm run debug-captcha
```

This will:
1. Launch a browser with full logging enabled
2. Navigate to the tracking page
3. Extract and save the main.js bundle containing the CAPTCHA algorithm
4. Log all network requests/responses with CAPTCHA headers
5. Log JavaScript console messages related to CAPTCHA
6. Save all logs to JSON files for analysis

## What the Debug Script Does

### 1. Network Interception

The script uses Chrome DevTools Protocol (CDP) to intercept all network traffic:

- **Requests**: Captures all outgoing requests, especially those to `/nges-portal/api/public/tracking-public/`
- **Responses**: Captures all incoming responses, including status codes and headers
- **CAPTCHA Headers**: Specifically logs:
  - `Captcha-Puzzle`: The challenge sent by the server
  - `Captcha-Solution`: The solution generated by the browser's JavaScript

### 2. JavaScript Bundle Extraction

The script automatically:
- Finds all JavaScript bundles loaded by the page
- Identifies the main bundle (usually `main.*.js`)
- Downloads and saves it to `captcha-algorithm-<timestamp>.js`
- Searches for CAPTCHA-related function definitions

### 3. Console Logging

Captures JavaScript console messages that mention:
- "captcha"
- "puzzle"
- "solution"

### 4. Log Files

After you press Enter, the script saves:

- **`captcha-network-logs-<timestamp>.json`**: All network requests/responses
- **`captcha-console-logs-<timestamp>.json`**: All console messages
- **`captcha-algorithm-<timestamp>.js`**: The main JavaScript bundle

## How to Use

1. **Run the script**:
   ```bash
   npm run debug-captcha
   ```

2. **Wait for the browser to open** and the page to load

3. **Solve the CAPTCHA** if one appears

4. **Search for a tracking number** (e.g., `1806203236`)

5. **Watch the console output** for:
   - Network requests with `Captcha-Solution` headers
   - Network responses with `Captcha-Puzzle` headers
   - JavaScript console messages about CAPTCHA

6. **Press Enter** when done to save all logs

## What to Look For

### In the Console Output

Look for these patterns:

```
ðŸ“¤ REQUEST: GET https://www.dbschenker.com/nges-portal/api/public/tracking-public/shipments?query=...
   âœ… Captcha-Solution: <base64-encoded-solution>
```

```
ðŸ“¥ RESPONSE: 429 https://www.dbschenker.com/nges-portal/api/public/tracking-public/shipments?query=...
   ðŸ§© Captcha-Puzzle: <puzzle-data>
```

```
ðŸ’¬ CONSOLE [log]: <message about captcha>
```

### In the JavaScript Bundle

Open `captcha-algorithm-<timestamp>.js` and search for:

1. **Function names** containing "captcha", "puzzle", or "solution"
2. **Variable names** related to CAPTCHA solving
3. **Algorithm logic** that:
   - Receives the `Captcha-Puzzle` header
   - Processes/solves the puzzle
   - Generates the `Captcha-Solution` header
   - Intercepts fetch requests to add the solution header

### In the Network Logs

Open `captcha-network-logs-<timestamp>.json` and look for:

1. **Request sequence**:
   - First request: No `Captcha-Solution` header â†’ Returns 429 with `Captcha-Puzzle`
   - Second request: Includes `Captcha-Solution` header â†’ Returns 200 OK

2. **Header values**:
   - What format is `Captcha-Puzzle`? (JSON, base64, etc.)
   - What format is `Captcha-Solution`? (base64-encoded JSON array)

3. **Timing**:
   - How long between receiving puzzle and sending solution?
   - Is there a retry mechanism?

## Key Information to Collect

When analyzing the CAPTCHA solving process, collect:

1. **Puzzle Format**: What does the `Captcha-Puzzle` header contain?
   - Is it JSON? Base64? Plain text?
   - What fields/properties does it have?

2. **Solution Format**: What does the `Captcha-Solution` header contain?
   - Base64-encoded JSON array with `jwt` and `solution` fields?
   - What is the structure?

3. **Algorithm Location**: Where in the JavaScript bundle is the solving logic?
   - Function names
   - Variable names
   - Code patterns

4. **Request Interception**: How does the JavaScript intercept requests?
   - Does it override `fetch`?
   - Does it use a service worker?
   - Does it use XMLHttpRequest interceptors?

5. **Timing**: When is the solution generated?
   - Immediately when puzzle is received?
   - After user interaction?
   - On a timer?

## Example Analysis Workflow

1. **Run the debug script** and complete a successful search

2. **Open the saved JavaScript bundle**:
   ```bash
   code captcha-algorithm-*.js
   # or
   cat captcha-algorithm-*.js | grep -i captcha
   ```

3. **Search for key terms**:
   ```bash
   grep -n "captcha\|puzzle\|solution" captcha-algorithm-*.js
   ```

4. **Analyze the network logs**:
   ```bash
   cat captcha-network-logs-*.json | jq '.[] | select(.url | contains("tracking-public"))'
   ```

5. **Look for the solving function**:
   - Search for functions that process the puzzle
   - Look for base64 encoding/decoding
   - Find where `Captcha-Solution` header is set

6. **Document your findings**:
   - Function names and locations
   - Algorithm steps
   - Input/output formats
   - Dependencies (DOM APIs, Web APIs, etc.)

## Sharing Findings

When you have information about the CAPTCHA solving process, share:

1. **The JavaScript bundle** (or relevant snippets)
2. **Network logs** showing the request/response flow
3. **Function names** and code locations
4. **Algorithm description** (what it does, step by step)
5. **Dependencies** (what browser APIs it uses)

This information will help implement the CAPTCHA solving logic in our codebase.

## Tips

- **Use a code formatter** on the JavaScript bundle to make it readable:
  ```bash
  npx prettier --write captcha-algorithm-*.js
  ```

- **Search for minified variable names** - the bundle is likely minified, so look for patterns like:
  - `function a(b,c)`
  - `const d = e.f()`
  - Short variable names that might be the algorithm

- **Look for base64 operations**:
  ```bash
  grep -n "btoa\|atob\|Buffer\|base64" captcha-algorithm-*.js
  ```

- **Check for fetch/XHR overrides**:
  ```bash
  grep -n "fetch\|XMLHttpRequest\|intercept" captcha-algorithm-*.js
  ```

